Redis
=========================================================================

Information about how to configure the redis servers We use three
redis instances

  1. Post: Store the posts.
  2. User: Stores user credentials and post limits.
  3. Msgs: Chat messages persistency.

  The config file for each instance can be found in the config
  directory.

  config/redis-post.conf
  config/redis-user.conf
  config/redis-msgs.conf

  These files are included in the distribution redis files. The
  version /etc/redis/* must have

  $ chown redis:redis file

- The instance are managed by systemd templace files. See systemd
  enable.

- Keyspace notification must be enabled for the msgs redis server
  (number 3. above). They are used to inform an occase-db instance
  that a user has messages waiting.

- Keyspace events is also needed at the moment by occase-notify. When
  a user is online occase-db will retrieve the messages and delete
  them from redis. The delete event is captured by occase notify to
  avoid sending a push notifcation to the user.

- The redis database file for posts and user credentials require safe
  storage while the msgs not so much.

- I am using port 1200 for the sentinel to be able to make the port
  range bigger for the occase-db.

- Configure the redis sentinels

   sentinel monitor post 127.0.0.1 1100 1
   sentinel monitor user 127.0.0.1 1101 1
   sentinel monitor msgs 127.0.0.1 1102 1

- Edit the redis systemd server and sentinel service files to not
  include pid file and forking.

occase-db
=========================================================================

On startup occase-db will retrieve the menu from the server, if not
available the process will exit with error. To load the menu on redis

   $ redis-cli -p 1100 flushall 
   OK
   $ cat channels.txt | redis-cli -p 1100 -x set channels
   OK
   $ sudo systemctl restart occase-db.service

Once the server is running it is possible to monitor internal queue
sizes and the current number of active sessions with the monitor tool

   $ occase-db-monitor

File descriptors
==========================================================================

For useful information about the number of file descriptors read
haproxy

   haproxy/doc/management.txt

For per process limit (see /proc/sys/fs/file-nr)

   $ sudo sysctl fs.nr_open

For the system wide limit (see /proc/sys/fs/file-max)

   $ sudo sysctl fs.file-max

These values can be changed by means of the sysctl comand.

Current available.

$ cat /proc/sys/fs/file-nr

Change /etc/security/limits.conf. Add for example.

*                soft    nofile          2000000
*                hard    nofile          2000000

To see the maximum in the current session

ulimit -Sn # Shows soft limit
ulimit -Hn # shows hard limit

To set a value.
ulimit -Sn value

Ephemeral ports file

/proc/sys/net/ipv4/ip_local_port_range

To change the range edit /etc/sysctl.conf witho

   # Increases the ip port range.
   net.ipv4.ip_local_port_range = 1024 65535

The number of open files

   $ sudo ls -l /proc/21610/fd | wc -l

To list the number of open tcp connections

$ ss -s

Certificate
=======================================================================

For deffie helman

   $ openssl dhparam -out dhparam4096.pem 4096
 
